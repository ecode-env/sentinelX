import subprocess
import os
from sentinelx_backend.config import Config
from sentinelx_backend.libs.tools.registry import register

@register('clamav', category='malware', description='ClamAV malware scan', input_schema='file')
def run(file_bytes):
    if not Config.ENABLE_CLAMAV:
        return {'ok': False, 'error': 'CLAMAV disabled by config'}
    try:
        with open('/tmp/scanfile', 'wb') as f:
            f.write(file_bytes)
        result = subprocess.run(['clamscan', '/tmp/scanfile'], capture_output=True, timeout=30)
        os.remove('/tmp/scanfile')
        infected = 'Infected files: 0' not in result.stdout.decode()
        return {
            'tool': 'clamav',
            'target': 'file',
            'ok': not infected,
            'severity': 'HIGH' if infected else 'INFO',
            'summary': 'Scan completed',
            'findings': [{'id': 'malware', 'title': 'Malware found', 'severity': 'HIGH', 'description': '', 'evidence': {}}] if infected else [],
            'raw': result.stdout.decode()
        }
    except Exception as e:
        return {'ok': False, 'error': str(e)}