import xml.etree.ElementTree as ET

def parse_webscanner_output(target: str, xml_data: str, tool: str = "webscanner") -> dict:
    """
    Parses OpenVAS / WebScanner XML output into structured JSON.
    """
    root = ET.fromstring(xml_data)
    vulnerabilities = []

    for host in root.findall("report_host"):
        for item in host.findall("report_item"):
            vulnerabilities.append({
                "name": item.find("name").text,
                "severity": item.get("severity"),
                "description": item.find("description").text,
                "solution": item.find("solution").text,
                "port": int(item.find("port").text) if item.find("port") is not None else None,
                "protocol": item.find("protocol").text if item.find("protocol") is not None else None
            })

    return {
        "ok": True,
        "tool": tool,
        "result": {
            "target": target,
            "vulnerabilities": vulnerabilities,
            "summary": {
                "total_vulnerabilities": len(vulnerabilities),
                "critical": sum(1 for v in vulnerabilities if v["severity"] == "4"),
                "high": sum(1 for v in vulnerabilities if v["severity"] == "3"),
                "medium": sum(1 for v in vulnerabilities if v["severity"] == "2"),
                "low": sum(1 for v in vulnerabilities if v["severity"] == "1")
            }
        }
    }
